{% extends "base.html" %}

{% block title %}Book Station{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <div class="card shadow-lg border-0">
        <div class="card-header text-white" style="background: linear-gradient(135deg, #0ea5e9 0%, #8b5cf6 100%);">
          <h4 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Book Charging Station</h4>
        </div>
        <div class="card-body">
          <!-- Station Info -->
          <div class="alert alert-info">
            <h5><i class="bi bi-ev-station-fill me-2"></i>{{ station.name }}</h5>
            <p class="mb-1"><i class="bi bi-geo-alt-fill me-2"></i>{{ station.city }}, {{ station.state }}</p>
            <p class="mb-1"><i class="bi bi-lightning-charge-fill me-2"></i>Available Power: {{ station.power_kW_each }} kW</p>
            <p class="mb-0"><i class="bi bi-cash me-2"></i>â‚¹{{ station.price_per_kWh_INR }}/kWh</p>
          </div>

          <!-- Wallet Balance -->
          <div class="alert alert-success">
            <i class="bi bi-wallet2 me-2"></i>
            <strong>Wallet Balance:</strong> â‚¹{{ "%.2f"|format(wallet_balance) }}
            <a href="{{ url_for('main.user_wallet') }}" class="btn btn-sm btn-success float-end">
              <i class="bi bi-plus-circle me-1"></i>Add Money
            </a>
          </div>

          <!-- Booking Form -->
          <form method="POST" id="bookingForm">
            <!-- Charger Power Selection -->
            <div class="mb-3">
              <label class="form-label"><i class="bi bi-plug-fill me-2"></i>Select Charger Power</label>
              <select class="form-select form-select-lg" name="charger_power" id="chargerPower" required>
                <option value="">-- Choose Charging Speed --</option>
              </select>
              <small class="text-muted">Higher power = Faster charging but higher cost</small>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label"><i class="bi bi-calendar3 me-2"></i>Booking Date</label>
                <input type="date" class="form-control" name="booking_date" 
                       min="{{ now.strftime('%Y-%m-%d') }}" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label"><i class="bi bi-clock me-2"></i>Booking Time</label>
                <input type="time" class="form-control" name="booking_time" required>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label"><i class="bi bi-hourglass-split me-2"></i>Duration (Hours)</label>
              <select class="form-select" name="duration" id="duration" required>
                <option value="0.5">30 minutes</option>
                <option value="1" selected>1 hour</option>
                <option value="1.5">1.5 hours</option>
                <option value="2">2 hours</option>
                <option value="3">3 hours</option>
                <option value="4">4 hours</option>
                <option value="5">5 hours</option>
              </select>
            </div>

            <div class="alert alert-warning">
              <h6><i class="bi bi-calculator me-2"></i>Estimated Cost</h6>
              <div id="costBreakdown" style="display:none;">
                <table class="table table-sm mb-2">
                  <tr>
                    <td>Charger Power:</td>
                    <td class="text-end"><strong><span id="selectedPower">-</span> kW</strong></td>
                  </tr>
                  <tr>
                    <td>Duration:</td>
                    <td class="text-end"><strong><span id="selectedDuration">-</span></strong></td>
                  </tr>
                  <tr>
                    <td>Rate:</td>
                    <td class="text-end">â‚¹{{ station.price_per_kWh_INR }}/kWh</td>
                  </tr>
                  <tr class="table-active">
                    <td><strong>Total Cost:</strong></td>
                    <td class="text-end"><strong class="text-success fs-5"><span id="estimatedCost">â‚¹0.00</span></strong></td>
                  </tr>
                </table>
                <small class="text-muted">Formula: Power (kW) Ã— Rate (â‚¹/kWh) Ã— Duration (hours)</small>
              </div>
              <p class="mb-0" id="selectChargerMsg">
                <i class="bi bi-info-circle me-2"></i>Please select charger power to see cost estimate
              </p>
            </div>

            <!-- Navigation Button -->
            <div class="mb-3">
              <button type="button" class="btn btn-outline-primary w-100" onclick="openNavigation()">
                <i class="bi bi-map me-2"></i>Get Directions to Station
              </button>
            </div>

            <button type="submit" class="btn btn-primary w-100 btn-lg">
              <i class="bi bi-check-circle me-2"></i>Confirm Booking
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Parse available power values from station
const powerStr = '{{ station.power_kW_each }}';
const pricePerKWh = parseFloat('{{ station.price_per_kWh_INR }}');

// Parse all available power options
const powerValues = powerStr.replace(/;/g, ',').split(',')
  .map(p => parseFloat(p.trim()))
  .filter(p => !isNaN(p) && p > 0);

// Remove duplicates and sort
const uniquePowers = [...new Set(powerValues)].sort((a, b) => a - b);

// Populate charger power dropdown
const chargerSelect = document.getElementById('chargerPower');
uniquePowers.forEach(power => {
  const option = document.createElement('option');
  option.value = power;
  
  // Categorize by speed
  let speedLabel = '';
  if (power <= 7) {
    speedLabel = 'ðŸŒ Slow Charging';
  } else if (power <= 22) {
    speedLabel = 'âš¡ Fast Charging';
  } else if (power <= 50) {
    speedLabel = 'ðŸš€ Rapid Charging';
  } else {
    speedLabel = 'âš¡âš¡ Ultra-Fast Charging';
  }
  
  // Calculate sample cost for 1 hour
  const sampleCost = (power * pricePerKWh).toFixed(2);
  
  option.textContent = `${power} kW - ${speedLabel} (â‚¹${sampleCost}/hour)`;
  chargerSelect.appendChild(option);
});

// Get form elements
const durationSelect = document.getElementById('duration');
const costDisplay = document.getElementById('estimatedCost');
const costBreakdown = document.getElementById('costBreakdown');
const selectChargerMsg = document.getElementById('selectChargerMsg');
const selectedPowerSpan = document.getElementById('selectedPower');
const selectedDurationSpan = document.getElementById('selectedDuration');

let selectedPower = 0;
let selectedDuration = 1;

// Update cost when charger power changes
chargerSelect.addEventListener('change', function() {
  selectedPower = parseFloat(this.value);
  updateCost();
});

// Update cost when duration changes
durationSelect.addEventListener('change', function() {
  selectedDuration = parseFloat(this.value);
  updateCost();
});

function updateCost() {
  if (selectedPower > 0) {
    costBreakdown.style.display = 'block';
    selectChargerMsg.style.display = 'none';
    
    const cost = selectedPower * pricePerKWh * selectedDuration;
    costDisplay.textContent = 'â‚¹' + cost.toFixed(2);
    selectedPowerSpan.textContent = selectedPower;
    
    // Format duration display
    if (selectedDuration < 1) {
      selectedDurationSpan.textContent = `${selectedDuration * 60} minutes`;
    } else {
      selectedDurationSpan.textContent = `${selectedDuration} hour${selectedDuration > 1 ? 's' : ''}`;
    }
  } else {
    costBreakdown.style.display = 'none';
    selectChargerMsg.style.display = 'block';
  }
}

// Get user location and open navigation
function openNavigation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;
      
      // Station location (using address)
      const stationAddress = encodeURIComponent('{{ station.name }}, {{ station.city }}, {{ station.state }}');
      
      // Open Google Maps with directions
      const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${stationAddress}&travelmode=driving`;
      window.open(mapsUrl, '_blank');
    }, function(error) {
      // If location access denied, just open station location
      const stationAddress = encodeURIComponent('{{ station.name }}, {{ station.city }}, {{ station.state }}');
      const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${stationAddress}`;
      window.open(mapsUrl, '_blank');
    });
  } else {
    alert('Geolocation is not supported by your browser');
  }
}

// Auto-open navigation when booking is confirmed
document.getElementById('bookingForm').addEventListener('submit', function(e) {
  // Navigation will open in new tab before form submits
  setTimeout(openNavigation, 100);
});
</script>
{% endblock %}
