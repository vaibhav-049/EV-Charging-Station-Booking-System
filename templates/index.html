{% extends 'base.html' %}
{% block title %}EV Stations - Browse{% endblock %}
{% block styles %}
<link href="{{ url_for('static', filename='css/index.css') }}" rel="stylesheet">
<style>
.station-card {
  border-radius: 16px;
  transition: all 0.3s ease;
  border: 2px solid rgba(14,165,233,0.15);
  height: 100%;
}
.station-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 30px rgba(14,165,233,0.2);
  border-color: #0ea5e9;
}
.station-badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
}
.map-container {
  height: 400px;
  border-radius: 16px;
  overflow: hidden;
  border: 2px solid rgba(14,165,233,0.2);
}
.nearby-badge {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}
.distance-badge {
  background: #f0f9ff;
  color: #0369a1;
  padding: 4px 10px;
  border-radius: 15px;
  font-size: 0.8rem;
  font-weight: 600;
}
/* Custom modal styling for clickability */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1050;
  overflow: auto;
}
.modal-dialog {
  position: relative;
  margin: 1.75rem auto;
  max-width: 500px;
  pointer-events: auto;
}
.modal-content {
  position: relative;
  background-color: #fff;
  border: 1px solid rgba(0,0,0,.2);
  border-radius: 0.5rem;
  box-shadow: 0 0.5rem 1rem rgba(0,0,0,.5);
  pointer-events: auto;
}
.modal-dialog-centered {
  display: flex;
  align-items: center;
  min-height: calc(100% - 3.5rem);
}
.modal-footer .btn {
  cursor: pointer !important;
  pointer-events: auto !important;
}
</style>
{% endblock %}
{% block content %}

{% if session.get('user_id') %}
<div class="modal" id="locationModal" tabindex="-1" style="display: none; background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="locationModalLabel"><i class="bi bi-geo-alt-fill me-2"></i>Enable Location</h5>
      </div>
      <div class="modal-body text-center py-4">
        <i class="bi bi-geo-alt-fill text-primary" style="font-size: 4rem;"></i>
        <h5 class="mt-3 mb-3">Find Nearby Charging Stations</h5>
        <p class="text-muted">Allow location access to see charging stations near you sorted by distance.</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-success btn-lg" id="enableLocationBtn" onclick="enableLocation()">
          <i class="bi bi-check-circle me-2"></i>Yes, Enable Location
        </button>
        <button type="button" class="btn btn-outline-secondary btn-lg" id="notNowBtn" onclick="closeLocationModal()">
          <i class="bi bi-x-circle me-2"></i>Not Now
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row mb-4">
  <div class="col-md-8">
    <h3><i class="bi bi-ev-station-fill me-2"></i>EV Charging Stations</h3>
  </div>
  <div class="col-md-4 text-end">
    <a href="{{ url_for('main.user_dashboard') }}" class="btn btn-outline-primary">
      <i class="bi bi-speedometer2 me-2"></i>My Dashboard
    </a>
  </div>
</div>

<!-- Location Search Bar -->
<div class="card mb-3 shadow-sm">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-10">
        <label class="form-label"><i class="bi bi-geo-alt-fill me-2 text-danger"></i><strong>Search by Location</strong></label>
        <input type="text" class="form-control form-control-lg" name="location" 
               placeholder="ðŸ” Enter city, state, or pincode..." 
               value="{{ location or '' }}">
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary btn-lg w-100" type="submit">
          <i class="bi bi-search me-2"></i>Search
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Map View Toggle -->
<div class="mb-3">
  <button class="btn btn-outline-success" onclick="toggleMap()">
    <i class="bi bi-map me-2"></i><span id="mapToggleText">Show Map View</span>
  </button>
  <button class="btn btn-outline-info" onclick="toggleView()">
    <i class="bi bi-grid-3x3-gap-fill me-2"></i><span id="viewToggleText">Switch to Table View</span>
  </button>
</div>

<!-- Map Container (Hidden by default) -->
<div id="mapContainer" class="card mb-3" style="display:none;">
  <div class="card-body">
    <div class="map-container" id="map">
      <!-- Map will be dynamically loaded here -->
    </div>
    <p class="text-muted mt-2 mb-0"><i class="bi bi-info-circle me-2"></i>Map showing EV charging stations in your area</p>
  </div>
</div>

<!-- Advanced Filters -->
<details class="mb-3">
  <summary class="btn btn-outline-secondary w-100 text-start">
    <i class="bi bi-funnel-fill me-2"></i>Advanced Filters
  </summary>
  <div class="card mt-2">
    <div class="card-body">
      <form class="row g-2" method="get">
        <div class="col-md-3">
          <label class="form-label">City</label>
          <select class="form-select" name="city">
            <option value="">All</option>
            {% for c in cities %}
              <option value="{{ c }}" {% if selected_city==c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Operator</label>
          <select class="form-select" name="operator">
            <option value="">All</option>
            {% for o in operators %}
              <option value="{{ o }}" {% if selected_operator==o %}selected{% endif %}>{{ o }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select class="form-select" name="status">
            <option value="">All</option>
            {% for s in statuses %}
              <option value="{{ s }}" {% if selected_status==s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Fast Charging</label>
          <select class="form-select" name="fast">
            <option value="">All</option>
            {% for f in fast_opts %}
              <option value="{{ f }}" {% if selected_fast==f %}selected{% endif %}>{{ f }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Price (INR/kWh)</label>
          <div class="input-group">
            <input type="number" step="0.01" min="0" class="form-control" placeholder="Min" name="price_min" value="{{ price_min }}">
            <span class="input-group-text">to</span>
            <input type="number" step="0.01" min="0" class="form-control" placeholder="Max" name="price_max" value="{{ price_max }}">
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label">Rating</label>
          <div class="input-group">
            <input type="number" step="0.1" min="0" max="5" class="form-control" placeholder="Min" name="rating_min" value="{{ rating_min }}">
            <span class="input-group-text">to</span>
            <input type="number" step="0.1" min="0" max="5" class="form-control" placeholder="Max" name="rating_max" value="{{ rating_max }}">
          </div>
        </div>
        <div class="col-12">
          <button class="btn btn-success"><i class="bi bi-funnel me-2"></i>Apply Filters</button>
          <a class="btn btn-secondary" href="{{ url_for('main.index') }}"><i class="bi bi-arrow-counterclockwise me-2"></i>Reset</a>
        </div>
      </form>
    </div>
  </div>
</details>

<!-- Results Count -->
<div class="mb-3">
  <p class="text-muted"><i class="bi bi-info-circle me-2"></i>Showing <strong>{{ df|length }}</strong> stations</p>
</div>

<!-- Card View (Default) -->
<div id="cardView" class="row g-3">
  {% for r in df.itertuples(index=False) %}
  <div class="col-md-6 col-lg-4" data-lat="{{ r.latitude }}" data-lng="{{ r.longitude }}">
    <div class="card station-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h5 class="card-title mb-0">{{ r.name }}</h5>
          {% if r.status == 'Active' %}
            <span class="station-badge bg-success text-white">Active</span>
          {% elif r.status == 'Offline' %}
            <span class="station-badge bg-danger text-white">Offline</span>
          {% else %}
            <span class="station-badge bg-warning text-dark">{{ r.status }}</span>
          {% endif %}
        </div>
        <p class="text-muted small mb-2"><i class="bi bi-building me-1"></i>{{ r.operator }}</p>
        <p class="text-muted small mb-2"><i class="bi bi-geo-alt-fill me-1"></i>{{ r.city }}, {{ r.state }}</p>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-primary"><strong>â‚¹{{ r.price_per_kWh_INR }}/kWh</strong></span>
          {% if r.fast_charging_supported == 'Yes' %}
            <span class="badge bg-warning text-dark"><i class="bi bi-lightning-charge-fill"></i> Fast Charging</span>
          {% endif %}
        </div>
        {% if r.station_rating %}
        <div class="mb-2">
          <span class="text-warning">
            {% for i in range((r.station_rating|float)|round|int) %}â˜…{% endfor %}
          </span>
          <small class="text-muted">{{ r.station_rating }}/5</small>
        </div>
        {% endif %}
        <div class="d-grid gap-2">
          {% if session.get('user_id') %}
          <a href="{{ url_for('main.book_station', station_id=r.station_id) }}" class="btn btn-success">
            <i class="bi bi-calendar-check me-2"></i>Book Now
          </a>
          {% endif %}
          <a href="{{ url_for('main.station_detail', station_id=r.station_id) }}" class="btn btn-outline-primary">
            <i class="bi bi-eye me-2"></i>View Details
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Table View (Hidden) -->
<div id="tableView" style="display:none;">
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Name</th>
          <th>City</th>
          <th>Operator</th>
          <th>Price</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in df.itertuples(index=False) %}
          <tr>
            <td>{{ r.name }}</td>
            <td>{{ r.city }}</td>
            <td>{{ r.operator }}</td>
            <td>â‚¹{{ r.price_per_kWh_INR }}</td>
            <td>
              {% if r.status == 'Active' %}
                <span class="badge bg-success">Active</span>
              {% elif r.status == 'Offline' %}
                <span class="badge bg-danger">Offline</span>
              {% else %}
                <span class="badge bg-warning text-dark">{{ r.status }}</span>
              {% endif %}
            </td>
            <td>
              {% if session.get('user_id') %}
              <a href="{{ url_for('main.book_station', station_id=r.station_id) }}" class="btn btn-sm btn-success me-1">
                <i class="bi bi-calendar-check"></i> Book
              </a>
              {% endif %}
              <a href="{{ url_for('main.station_detail', station_id=r.station_id) }}" class="btn btn-sm btn-primary">
                <i class="bi bi-eye"></i> View
              </a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
let userLocation = null;

function openLocationModal() {
  const modal = document.getElementById('locationModal');
  if (modal) {
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }
}

function closeLocationModal() {
  const modal = document.getElementById('locationModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
}

window.addEventListener('DOMContentLoaded', function() {
  const locationEnabled = sessionStorage.getItem('locationEnabled');
  
  {% if session.get('user_id') %}
  if (!locationEnabled) {
    openLocationModal();
  } else {
    tryGetLocation();
  }
  {% endif %}
});

function enableLocation() {
  closeLocationModal();
  
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        sessionStorage.setItem('locationEnabled', 'true');
        sortStationsByDistance();
        showSuccessMessage();
      },
      function(error) {
        sessionStorage.removeItem('locationEnabled');
        alert('Location access was denied. Please enable location in your browser settings to see nearby stations.');
      }
    );
  } else {
    alert('Geolocation is not supported by your browser.');
  }
}

function tryGetLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        sortStationsByDistance();
      },
      function(error) {
        // Silently fail
      }
    );
  }
}

function showSuccessMessage() {
  const alertDiv = document.createElement('div');
  alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
  alertDiv.style.zIndex = '9999';
  alertDiv.innerHTML = `
    <i class="bi bi-check-circle-fill me-2"></i>
    <strong>Location Enabled!</strong> Showing nearby stations first.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  document.body.appendChild(alertDiv);
  setTimeout(() => alertDiv.remove(), 4000);
}

// Calculate distance between two coordinates (Haversine formula)
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // Radius of Earth in km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c; // Distance in km
}

function sortStationsByDistance() {
  if (!userLocation) return;
  
  const cardView = document.getElementById('cardView');
  const cards = Array.from(cardView.children);
  
  // Add distance to each card
  cards.forEach(card => {
    const lat = parseFloat(card.dataset.lat);
    const lng = parseFloat(card.dataset.lng);
    const distance = calculateDistance(userLocation.lat, userLocation.lng, lat, lng);
    card.dataset.distance = distance;
    
    // Add distance badge
    const cardBody = card.querySelector('.card-body');
    const stationName = cardBody.querySelector('h5');
    
    // Remove existing badges if any
    const existingBadge = cardBody.querySelector('.distance-badge');
    if (existingBadge) existingBadge.remove();
    
    const distanceBadge = document.createElement('span');
    distanceBadge.className = 'distance-badge ms-2';
    distanceBadge.innerHTML = `<i class="bi bi-geo-fill me-1"></i>${distance.toFixed(1)} km away`;
    stationName.appendChild(distanceBadge);
    
    // Add "Nearby" badge for stations within 10km
    if (distance <= 10) {
      const existingNearby = cardBody.querySelector('.nearby-badge');
      if (!existingNearby) {
        const nearbyBadge = document.createElement('span');
        nearbyBadge.className = 'nearby-badge ms-2';
        nearbyBadge.innerHTML = '<i class="bi bi-lightning-fill me-1"></i>NEARBY';
        stationName.appendChild(nearbyBadge);
      }
    }
  });
  
  // Sort cards by distance
  cards.sort((a, b) => {
    const distA = parseFloat(a.dataset.distance) || Infinity;
    const distB = parseFloat(b.dataset.distance) || Infinity;
    return distA - distB;
  });
  
  // Re-append sorted cards
  cards.forEach(card => cardView.appendChild(card));
}

function toggleMap() {
  const mapContainer = document.getElementById('mapContainer');
  const toggleText = document.getElementById('mapToggleText');
  
  console.log('Toggle map clicked, current display:', mapContainer.style.display);
  
  if (mapContainer.style.display === 'none' || mapContainer.style.display === '') {
    mapContainer.style.display = 'block';
    toggleText.textContent = 'Hide Map View';
    console.log('Loading map...');
    setTimeout(() => loadMap(), 100); // Small delay to ensure container is visible
  } else {
    mapContainer.style.display = 'none';
    toggleText.textContent = 'Show Map View';
  }
}

function loadMap() {
  const mapDiv = document.getElementById('map');
  console.log('loadMap called, mapDiv:', mapDiv);
  
  // Get all stations with coordinates
  const stations = [];
  {% for r in df.itertuples(index=False) %}
  try {
    const lat = parseFloat({{ r.latitude }});
    const lng = parseFloat({{ r.longitude }});
    if (!isNaN(lat) && !isNaN(lng)) {
      stations.push({
        name: "{{ r.name }}",
        lat: lat,
        lng: lng,
        city: "{{ r.city }}",
        state: "{{ r.state }}"
      });
    }
  } catch(e) {
    console.error('Error parsing station coordinates:', e);
  }
  {% endfor %}
  
  console.log('Total valid stations:', stations.length);
  
  if (stations.length === 0) {
    mapDiv.innerHTML = '<div class="alert alert-warning text-center mt-3"><i class="bi bi-exclamation-triangle me-2"></i>No stations with valid coordinates found</div>';
    return;
  }
  
  let centerLat, centerLng;
  if (userLocation) {
    centerLat = userLocation.lat;
    centerLng = userLocation.lng;
  } else if (stations.length > 0) {
    centerLat = stations[0].lat;
    centerLng = stations[0].lng;
  } else {
    centerLat = 23.0225;
    centerLng = 72.5714;
  }
  
  // Use simpler Google Maps embed (without too many markers)
  const mapUrl = `https://www.google.com/maps/embed/v1/view?key=AIzaSyDummy&center=${centerLat},${centerLng}&zoom=11`;
  
  // Fallback to basic maps URL without API key
  const fallbackUrl = `https://maps.google.com/maps?q=${centerLat},${centerLng}&z=11&output=embed`;
  
  console.log('Loading map with center:', centerLat, centerLng);
  
  // Add location prompt if user hasn't enabled location
  const locationPrompt = !userLocation ? `
    <div class="alert alert-info alert-dismissible fade show m-3" role="alert">
      <i class="bi bi-info-circle me-2"></i>
      <strong>Tip:</strong> Enable location to center map on your current position!
      <button type="button" class="btn btn-sm btn-primary ms-2" onclick="openLocationModal()">
        <i class="bi bi-geo-alt-fill me-1"></i>Enable Location
      </button>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  ` : '';
  
  mapDiv.innerHTML = `
    ${locationPrompt}
    <div class="position-relative">
      <iframe 
        width="100%" 
        height="400" 
        frameborder="0" 
        style="border:0;border-radius:10px;"
        src="${fallbackUrl}"
        allowfullscreen
        loading="lazy">
      </iframe>
      <div class="position-absolute top-0 start-0 m-3 bg-white px-3 py-2 rounded shadow-sm">
        <small class="text-muted"><i class="bi bi-geo-alt-fill text-danger me-1"></i>${stations.length} stations</small>
        ${userLocation ? '<br><small class="text-success"><i class="bi bi-geo-fill me-1"></i>Your Location</small>' : ''}
      </div>
    </div>
  `;
  
  console.log('Map iframe created successfully');
}

function toggleView() {
  const cardView = document.getElementById('cardView');
  const tableView = document.getElementById('tableView');
  const toggleText = document.getElementById('viewToggleText');
  
  if (cardView.style.display === 'none') {
    cardView.style.display = 'flex';
    tableView.style.display = 'none';
    toggleText.textContent = 'Switch to Table View';
  } else {
    cardView.style.display = 'none';
    tableView.style.display = 'block';
    toggleText.textContent = 'Switch to Card View';
  }
}
</script>
{% endblock %}
